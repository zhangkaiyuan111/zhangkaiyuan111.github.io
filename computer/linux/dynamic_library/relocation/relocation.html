
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>2.1 重定位 · ebook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="zhangkaiyuan">
        
        
    
    <link rel="stylesheet" href="../../../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="../../../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../../../../literature/literature.html" />
    
    
    <link rel="prev" href="../dynamicLibrary.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../../../">
            
                <a href="../../../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../../computer.html">
            
                <a href="../../../computer.html">
            
                    
                    计算机
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../../../glibc/glibc.html">
            
                <a href="../../../glibc/glibc.html">
            
                    
                    glibc
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1" data-path="../../../glibc/memoryManagement/memoryManagement.html">
            
                <a href="../../../glibc/memoryManagement/memoryManagement.html">
            
                    
                    1 虚拟地址分配和分页
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1.1" data-path="../../../glibc/memoryManagement/ProcessMemoryConcepts.html">
            
                <a href="../../../glibc/memoryManagement/ProcessMemoryConcepts.html">
            
                    
                    1.1 进程内存概念
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.1.2" data-path="../../../glibc/memoryManagement/GNUAllocator.html">
            
                <a href="../../../glibc/memoryManagement/GNUAllocator.html">
            
                    
                    1.2 GNU 分配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.1.3" data-path="../../../glibc/memoryManagement/pageTable.html">
            
                <a href="../../../glibc/memoryManagement/pageTable.html">
            
                    
                    1.3 页表
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.1.4" data-path="../../../glibc/memoryManagement/gdbDebug.html">
            
                <a href="../../../glibc/memoryManagement/gdbDebug.html">
            
                    
                    1.4 gdb调试
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../../linux.html">
            
                <a href="../../linux.html">
            
                    
                    linux
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.2.1" data-path="../../elfFile.html">
            
                <a href="../../elfFile.html">
            
                    
                    1 elf文件详解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.2" data-path="../dynamicLibrary.html">
            
                <a href="../dynamicLibrary.html">
            
                    
                    2 动态库
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.2.2.2.1" data-path="relocation.html">
            
                <a href="relocation.html">
            
                    
                    2.1 重定位
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../../../../literature/literature.html">
            
                <a href="../../../../literature/literature.html">
            
                    
                    文学
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../../../../literature/poetry/poetry.html">
            
                <a href="../../../../literature/poetry/poetry.html">
            
                    
                    诗词
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="../../../../literature/poetry/sushi/sushi.html">
            
                <a href="../../../../literature/poetry/sushi/sushi.html">
            
                    
                    苏轼
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1.1" data-path="../../../../literature/poetry/sushi/1.html">
            
                <a href="../../../../literature/poetry/sushi/1.html">
            
                    
                    《定风波·莫听穿林打叶声》
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../../.." >2.1 重定位</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="&#x52A8;&#x6001;&#x5E93;&#x91CD;&#x5B9A;&#x4F4D;"><center> &#x52A8;&#x6001;&#x5E93;&#x91CD;&#x5B9A;&#x4F4D;</center></h1>
<h3 id="&#x52A8;&#x6001;&#x5E93;&#x91CD;&#x5B9A;&#x4F4D;&#x7684;&#x4E24;&#x79CD;&#x65B9;&#x5F0F;&#xFF1A;">&#x52A8;&#x6001;&#x5E93;&#x91CD;&#x5B9A;&#x4F4D;&#x7684;&#x4E24;&#x79CD;&#x65B9;&#x5F0F;&#xFF1A;</h3>
<ol>
<li>&#x52A0;&#x8F7D;&#x65F6;&#x91CD;&#x5B9A;&#x4F4D;&#xFF0C;&#x53C8;&#x79F0;&#x9759;&#x6001;&#x52A0;&#x8F7D;&#x6216;&#x9690;&#x5F0F;&#x52A0;&#x8F7D;&#xFF0C;&#x5728;&#x94FE;&#x63A5;&#x65F6;&#x5C06;&#x5176;&#x94FE;&#x63A5;&#x8FDB;&#x76EE;&#x6807;&#x6587;&#x4EF6;&#x3002;</li>
<li><p>&#x8FD0;&#x884C;&#x65F6;&#x91CD;&#x5B9A;&#x4F4D;&#xFF0C;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x6216;&#x663E;&#x5F0F;&#x52A0;&#x8F7D;&#xFF0C;&#x5728;&#x7A0B;&#x5E8F;&#x4E2D;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x52A8;&#x6001;&#x5E93;&#xFF0C;&#x5F53;&#x8FD0;&#x884C;&#x5230;&#x52A0;&#x8F7D;&#x5904;&#x65F6;&#xFF0C;&#x624D;&#x4F1A;&#x5C06;&#x52A8;&#x6001;&#x5E93;&#x52A0;&#x8F7D;&#x8FDB;&#x6765;&#x3002;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x9700;&#x8981;&#x5305;&#x542B;&#x7684;&#x5934;&#x6587;&#x4EF6;&#xFF1A;#include<dlfcn.h><br>api&#xFF1A;<br>// &#x6253;&#x5F00;&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x5E93;<br>void <em>dlopen (const char </em>filename, int flag);  </dlfcn.h></p>
<p>//&#x53D6;&#x51FD;&#x6570;<br>void <em>dlsym(void </em>handle, char *symbol);  </p>
<p>// &#x5173;&#x95ED;&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x5E93;<br>int dlclose (void *handle); </p>
</li>
</ol>
<h3 id="&#x672C;&#x6587;&#x6D4B;&#x8BD5;&#x4EE3;&#x7801;">&#x672C;&#x6587;&#x6D4B;&#x8BD5;&#x4EE3;&#x7801;</h3>
<ol>
<li>&#x52A8;&#x6001;&#x5E93;&#x6E90;&#x7801;  </li>
</ol>
<pre><code class="lang-c">#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
int mem_tst = 2;

int memLibTest() {
    char* p1 = malloc(32);
    snprintf(p1, 32, &quot;hello, I am here in .so&quot;);
    mem_tst = 9;
    int i = 0;
    i = 10;
    return 0;
}
</code></pre>
<ol>
<li>&#x6D4B;&#x8BD5;&#x4E3B;&#x7A0B;&#x5E8F;  </li>
</ol>
<pre><code class="lang-c">#define _GNU_SOURCE
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;link.h&gt;
#include &lt;unistd.h&gt;
#include &quot;t_mem_lib.h&quot;

static int gl = 5;
static void t() {
    char* p2 = malloc(32);
    snprintf(p2, 32, &quot;hello, I am here 2&quot;);
}

static int header_handler(struct dl_phdr_info* info, size_t size, void* data)
{
     printf(&quot;name=%s (%d segments) address=%p\n&quot;,
             info-&gt;dlpi_name, info-&gt;dlpi_phnum, (void*)info-&gt;dlpi_addr);
     for (int j = 0; j &lt; info-&gt;dlpi_phnum; j++) {
          printf(&quot;\t\t header %2d: address=%10p\n&quot;, j,
              (void*) (info-&gt;dlpi_addr + info-&gt;dlpi_phdr[j].p_vaddr));
          printf(&quot;\t\t\t type=%u, flags=0x%X\n&quot;,
                 info-&gt;dlpi_phdr[j].p_type, info-&gt;dlpi_phdr[j].p_flags);
     }   
     printf(&quot;\n&quot;);
     return 0;
}

extern int mem_tst;
int main(int argc, char **argv) {
    char* p1 = malloc(32);
    snprintf(p1, 32, &quot;hello, I am here 1&quot;);
    printf(&quot;111111111111\n&quot;);
    gl = 10;
    dl_iterate_phdr(header_handler, NULL);
    memLibTest();
    t();
    int i = 5;
    while(i--) {
        sleep(1);
    }
    return 0;
}
</code></pre>
<h3 id="&#x52A8;&#x6001;&#x5E93;&#x4E2D;&#x53D8;&#x91CF;&#x7684;&#x91CD;&#x5B9A;&#x4F4D;&#x8FC7;&#x7A0B;">&#x52A8;&#x6001;&#x5E93;&#x4E2D;&#x53D8;&#x91CF;&#x7684;&#x91CD;&#x5B9A;&#x4F4D;&#x8FC7;&#x7A0B;</h3>
<ul>
<li>&#x6E90;&#x7801;&#x7F16;&#x8BD1;&#x5B8C;&#x6210;&#xFF0C;&#x901A;&#x8FC7;readelf -r libtstmem.so&#x547D;&#x4EE4;&#xFF0C;&#x770B;&#x4E0B;&#x52A8;&#x6001;&#x91CD;&#x5B9A;&#x4F4D;&#x533A;&#x7684;&#x6570;&#x636E;&#xFF1A;  </li>
</ul>
<pre><code class="lang-c">x@ubuntu:~/work/libs/libraries$ readelf -r output/build/app/glibc/libtstmem.so

Relocation section &apos;.rela.dyn&apos; at offset 0x4d8 contains 8 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000003de8  000000000008 R_X86_64_RELATIVE                    1130
000000003df0  000000000008 R_X86_64_RELATIVE                    10f0
000000004028  000000000008 R_X86_64_RELATIVE                    4028
000000003fd8  000100000006 R_X86_64_GLOB_DAT 0000000000000000 _ITM_deregisterTMClone + 0
000000003fe0  000700000006 R_X86_64_GLOB_DAT 0000000000004030 mem_tst + 0
000000003fe8  000300000006 R_X86_64_GLOB_DAT 0000000000000000 __gmon_start__ + 0
000000003ff0  000500000006 R_X86_64_GLOB_DAT 0000000000000000 _ITM_registerTMCloneTa + 0
000000003ff8  000600000006 R_X86_64_GLOB_DAT 0000000000000000 __cxa_finalize@GLIBC_2.2.5 + 0

Relocation section &apos;.rela.plt&apos; at offset 0x598 contains 2 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000004018  000200000007 R_X86_64_JUMP_SLO 0000000000000000 snprintf@GLIBC_2.2.5 + 0
000000004020  000400000007 R_X86_64_JUMP_SLO 0000000000000000 malloc@GLIBC_2.2.5 + 0
</code></pre>
<p>.rel.dyn&#x8868;&#x793A;&#x52A8;&#x6001;&#x91CD;&#x5B9A;&#x4F4D;&#x533A;&#x3002;&#x52A8;&#x6001;&#x5E93;&#x5728;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x91CD;&#x5B9A;&#x4F4D;&#x5C31;&#x662F;&#x4F7F;&#x7528;.rel.dyn&#x91CD;&#x5B9A;&#x4F4D;&#x6570;&#x636E;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x53D8;&#x91CF; mem_tst &#x5728;&#x52A8;&#x6001;&#x5E93;&#x4E2D;&#x7684;&#x504F;&#x79FB;&#x91CF; Sym. Value&#xFF08;0000000000004030&#xFF09;&#x5904;&#xFF0C;&#x53D8;&#x91CF;&#x771F;&#x5B9E;&#x5730;&#x5740;&#x5B58;&#x653E;&#x5728; &#x5E93;&#x4E2D;&#x504F;&#x79FB;&#x91CF; Offset&#xFF08;000000003fe0&#xFF09;&#x5904;&#x3002;  </p>
<p>&#x901A;&#x8FC7;&#x547D;&#x4EE4; objdump -d -j .text libtstmem.so&#xFF0C;dump&#x51FA;&#x52A8;&#x6001;&#x5E93;&#x4E2D;&#x7684;&#x6C47;&#x7F16;&#x6307;&#x4EE4;&#x5982;&#x4E0B;&#xFF0C;&#x622A;&#x53D6;&#x4E00;&#x90E8;&#x5206;&#xFF1A;  </p>
<pre><code>x@ubuntu:~/work/libs/libraries$ objdump -d -j .text output/build/app/glibc/libtstmem.so

output/build/app/glibc/libtstmem.so:     file format elf64-x86-64


Disassembly of section .text:

0000000000001139 &lt;memLibTest&gt;:
    1139:       f3 0f 1e fa             endbr64
    113d:       55                      push   %rbp
    113e:       48 89 e5                mov    %rsp,%rbp
    1141:       48 83 ec 10             sub    $0x10,%rsp
    1145:       bf 20 00 00 00          mov    $0x20,%edi
    114a:       e8 21 ff ff ff          callq  1070 &lt;malloc@plt&gt;
    114f:       48 89 45 f8             mov    %rax,-0x8(%rbp)
    1153:       48 8b 45 f8             mov    -0x8(%rbp),%rax
    1157:       48 8d 15 a2 0e 00 00    lea    0xea2(%rip),%rdx        # 2000 &lt;_fini+0xe6c&gt;
    115e:       be 20 00 00 00          mov    $0x20,%esi
    1163:       48 89 c7                mov    %rax,%rdi
    1166:       b8 00 00 00 00          mov    $0x0,%eax
    116b:       e8 f0 fe ff ff          callq  1060 &lt;snprintf@plt&gt;
    1170:       48 8b 05 69 2e 00 00    mov    0x2e69(%rip),%rax        # 3fe0 &lt;mem_tst@@Base-0x50&gt;
    1177:       c7 00 09 00 00 00       movl   $0x9,(%rax)
    117d:       c7 45 f4 00 00 00 00    movl   $0x0,-0xc(%rbp)
    1184:       c7 45 f4 0a 00 00 00    movl   $0xa,-0xc(%rbp)
    118b:       b8 00 00 00 00          mov    $0x0,%eax
    1190:       c9                      leaveq
    1191:       c3                      retq
</code></pre><p>&#x6C47;&#x7F16;&#x6307;&#x4EE4;&#x4E2D;<br>mov    0x2e69(%rip),%rax        # 3fe0 <a href="mailto:mem_tst@@Base-0x50" target="_blank">mem_tst@@Base-0x50</a> &#x8BED;&#x53E5;&#xFF0C;&#x628A;&#x53D8;&#x91CF;&#x7684;&#x5730;&#x5740;&#x653E;&#x5230;rax&#x5BC4;&#x5B58;&#x5668;&#x4E2D;<br>movl   $0x9,(%rax) &#x8BED;&#x53E5;&#xFF0C;&#x5C06;rax&#x5BC4;&#x5B58;&#x5668;&#x5730;&#x5740;&#x5904;&#x7684;&#x503C;&#x8BBE;&#x7F6E;&#x4E3A;&#x7ACB;&#x5373;&#x6570;0x9  </p>
<p>&#x4E0B;&#x9762;&#x542F;&#x7528;gdb&#x5206;&#x6790;&#x53D8;&#x91CF; mem_tst &#x5728;&#x5185;&#x5B58;&#x4E2D;&#x7684;&#x5730;&#x5740;  </p>
<pre><code>x@ubuntu:~/work/libs/libraries$ gdb ./output/build/app/glibc/tmem
GNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2
Copyright (C) 2020 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type &quot;show copying&quot; and &quot;show warranty&quot; for details.
This GDB was configured as &quot;x86_64-linux-gnu&quot;.
Type &quot;show configuration&quot; for configuration details.
For bug reporting instructions, please see:
&lt;http://www.gnu.org/software/gdb/bugs/&gt;.
Find the GDB manual and other documentation resources online at:
    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.

For help, type &quot;help&quot;.
Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;...
Reading symbols from ./output/build/app/glibc/tmem...
(gdb) b 36
Breakpoint 1 at 0x13ee: file /home/x/work/libs/libraries/app/glibc/t_mem.c, line 36.
(gdb) r
Starting program: /home/x/work/libs/libraries/output/build/app/glibc/tmem
111111111111
name= (13 segments) address=0x555555554000
                 header  0: address=0x555555554040
                         type=6, flags=0x4
                 header  1: address=0x555555554318
                         type=3, flags=0x4
                 header  2: address=0x555555554000
                         type=1, flags=0x4
                 header  3: address=0x555555555000
                         type=1, flags=0x5
                 header  4: address=0x555555556000
                         type=1, flags=0x4
                 header  5: address=0x555555557d60
                         type=1, flags=0x6
                 header  6: address=0x555555557d70
                         type=2, flags=0x6
                 header  7: address=0x555555554348
                         type=4, flags=0x4
                 header  8: address=0x555555554368
                         type=4, flags=0x4
                 header  9: address=0x555555554348
                         type=1685382483, flags=0x4
                 header 10: address=0x555555556098
                         type=1685382480, flags=0x4
                 header 11: address=0x555555554000
                         type=1685382481, flags=0x6
                 header 12: address=0x555555557d60
                         type=1685382482, flags=0x4

name=linux-vdso.so.1 (4 segments) address=0x7ffff7fc7000
                 header  0: address=0x7ffff7fc7000
                         type=1, flags=0x5
                 header  1: address=0x7ffff7fc73e0
                         type=2, flags=0x4
                 header  2: address=0x7ffff7fc7500
                         type=4, flags=0x4
                 header  3: address=0x7ffff7fc7554
                         type=1685382480, flags=0x4

name=/home/x/work/libs/libraries/output/build/app/glibc/libtstmem.so (11 segments) address=0x7ffff7fbc000
                 header  0: address=0x7ffff7fbc000
                         type=1, flags=0x4
                 header  1: address=0x7ffff7fbd000
                         type=1, flags=0x5
                 header  2: address=0x7ffff7fbe000
                         type=1, flags=0x4
                 header  3: address=0x7ffff7fbfde8
                         type=1, flags=0x6
                 header  4: address=0x7ffff7fbfdf8
                         type=2, flags=0x6
                 header  5: address=0x7ffff7fbc2a8
                         type=4, flags=0x4
                 header  6: address=0x7ffff7fbc2c8
                         type=4, flags=0x4
                 header  7: address=0x7ffff7fbc2a8
                         type=1685382483, flags=0x4
                 header  8: address=0x7ffff7fbe018
                         type=1685382480, flags=0x4
                 header  9: address=0x7ffff7fbc000
                         type=1685382481, flags=0x6
                 header 10: address=0x7ffff7fbfde8
                         type=1685382482, flags=0x4

name=/usr/local/glibc2.37/lib/libc.so.6 (14 segments) address=0x7ffff7def000
                 header  0: address=0x7ffff7def040
                         type=6, flags=0x4
                 header  1: address=0x7ffff7f77b20
                         type=3, flags=0x4
                 header  2: address=0x7ffff7def000
                         type=1, flags=0x4
                 header  3: address=0x7ffff7e17000
                         type=1, flags=0x5
                 header  4: address=0x7ffff7f52000
                         type=1, flags=0x4
                 header  5: address=0x7ffff7fa9c58
                         type=1, flags=0x6
                 header  6: address=0x7ffff7facbc0
                         type=2, flags=0x6
                 header  7: address=0x7ffff7def350
                         type=4, flags=0x4
                 header  8: address=0x7ffff7def380
                         type=4, flags=0x4
                 header  9: address=0x7ffff7fa9c58
                         type=7, flags=0x4
                 header 10: address=0x7ffff7def350
                         type=1685382483, flags=0x4
                 header 11: address=0x7ffff7f77b50
                         type=1685382480, flags=0x4
                 header 12: address=0x7ffff7def000
                         type=1685382481, flags=0x6
                 header 13: address=0x7ffff7fa9c58
                         type=1685382482, flags=0x4

name=/usr/local/glibc2.37/lib/ld-linux-x86-64.so.2 (11 segments) address=0x7ffff7fc9000
                 header  0: address=0x7ffff7fc9000
                         type=1, flags=0x4
                 header  1: address=0x7ffff7fca000
                         type=1, flags=0x5
                 header  2: address=0x7ffff7fef000
                         type=1, flags=0x4
                 header  3: address=0x7ffff7ffbaa0
                         type=1, flags=0x6
                 header  4: address=0x7ffff7ffcec0
                         type=2, flags=0x6
                 header  5: address=0x7ffff7fc92a8
                         type=4, flags=0x4
                 header  6: address=0x7ffff7fc92c8
                         type=4, flags=0x4
                 header  7: address=0x7ffff7fc92a8
                         type=1685382483, flags=0x4
                 header  8: address=0x7ffff7ff5460
                         type=1685382480, flags=0x4
                 header  9: address=0x7ffff7fc9000
                         type=1685382481, flags=0x6
                 header 10: address=0x7ffff7ffbaa0
                         type=1685382482, flags=0x4


Breakpoint 1, main (argc=1, argv=0x7fffffffe1b8) at /home/x/work/libs/libraries/app/glibc/t_mem.c:36
36          t();
(gdb)
</code></pre><p>&#x53EF;&#x4EE5;&#x770B;&#x5230; libtstmem.so &#x5E93;&#x52A0;&#x8F7D;&#x5230;&#x4E86;&#x5185;&#x5B58;&#x7684; address=0x7ffff7fbc000 &#x5730;&#x5740;&#x5904;&#xFF0C;&#x6839;&#x636E;&#x4E0A;&#x9762;&#x5206;&#x6790;&#xFF0C;&#x53D8;&#x91CF; mem_tst &#x5728;&#x5E93;&#x4E2D;&#x7684;&#x504F;&#x79FB;&#x4E3A; 0x4030&#xFF0C;&#x6240;&#x4EE5;&#x5E94;&#x8BE5;&#x5728; 0x7ffff7fbc000 + 0x4030 = 0x7ffff7fc0030 &#x5730;&#x5740;&#x5904;&#xFF0C;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x6253;&#x5370; mem_tst &#x5730;&#x5740;  </p>
<pre><code>(gdb) print &amp;mem_tst
$1 = (int *) 0x7ffff7fc0030 &lt;mem_tst&gt;
(gdb)
</code></pre><p>Cool&#xFF0C;&#x548C;&#x6211;&#x4EEC;&#x8BA1;&#x7B97;&#x51FA;&#x6765;&#x7684;&#x5730;&#x5740;&#x5339;&#x914D;&#xFF0C;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x518D;&#x6765;&#x6253;&#x5370; 0x3fe0 &#x504F;&#x79FB;&#x5904;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x5373; 0x7ffff7fbc000 + 0x3fe0 = 0x7ffff7fbffe0 &#x5730;&#x5740;&#x5904;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x770B;&#x4E00;&#x4E0B;&#x662F;&#x4E0D;&#x662F;&#x53D8;&#x91CF; mem_tst &#x7684;&#x771F;&#x5B9E;&#x5730;&#x5740;&#xFF1A;  </p>
<pre><code>(gdb) x /8xb 0x7ffff7fbffe0
0x7ffff7fbffe0: 0x30    0x00    0xfc    0xf7    0xff    0x7f    0x00    0x00
(gdb)
</code></pre><p>&#x5904;&#x7406;&#x5668;&#x4E3A;&#x5C0F;&#x7AEF;&#x683C;&#x5F0F;&#xFF0C;&#x6240;&#x4EE5; 0x7ffff7fbffe0 &#x5730;&#x5740;&#x5904;&#x7684;&#x5185;&#x5BB9;&#x4E3A; 0x7ffff7fc0030&#xFF0C;&#x548C;&#x6253;&#x5370;&#x51FA;&#x7684;&#x53D8;&#x91CF; mem_tst &#x5730;&#x5740;&#x76F8;&#x540C;&#x3002;  </p>
<p>&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x518D;&#x6765;&#x5206;&#x6790;&#x6C47;&#x7F16;&#x6307;&#x4EE4; mov    0x2e69(%rip),%rax        # 3fe0 <a href="mailto:mem_tst@@Base-0x50" target="_blank">mem_tst@@Base-0x50</a> &#x4E2D;0x2e69&#x7684;&#x7531;&#x6765;&#xFF0C;&#x8BE5;&#x6761;&#x6C47;&#x7F16;&#x6307;&#x4EE4;&#x5730;&#x5740;&#x5728;&#x52A8;&#x6001;&#x5E93;&#x4E2D;&#x7684;&#x504F;&#x79FB;&#x91CF;&#x4E3A;0x1170&#xFF0C;&#x5B83;&#x7684;&#x4E0B;&#x4E00;&#x6761;&#x6307;&#x4EE4;&#x7684;&#x5730;&#x5740;&#x504F;&#x79FB;&#x4E3A; 0x1177&#xFF0C;&#x53D8;&#x91CF; mem_tst &#x5730;&#x5740;&#x4FDD;&#x5B58;&#x5728;&#x91CD;&#x5B9A;&#x4F4D;&#x533A; .rela.dyn &#x4E2D;&#xFF0C;&#x5728;&#x52A8;&#x6001;&#x5E93;&#x4E2D;&#x7684;&#x504F;&#x79FB;&#x91CF;&#x4E3A; 0x3fe0&#xFF0C;&#x6B64;&#x65F6; 0x3fe0 - 0x1177 &#x7684;&#x8BA1;&#x7B97;&#x7ED3;&#x679C;&#xFF08;0x2e69&#xFF09;&#x5373;&#x4E3A; mov &#x6307;&#x4EE4;&#x4E2D;rip &#x7684;&#x504F;&#x79FB;&#x3002;<br>&#x901A;&#x8FC7;adb disassemble &#x547D;&#x4EE4;&#x6253;&#x5370;&#x6C47;&#x7F16;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;  </p>
<pre><code>(gdb) disassemble
Dump of assembler code for function memLibTest:
   0x00007ffff7fbd139 &lt;+0&gt;:     endbr64
   0x00007ffff7fbd13d &lt;+4&gt;:     push   %rbp
   0x00007ffff7fbd13e &lt;+5&gt;:     mov    %rsp,%rbp
   0x00007ffff7fbd141 &lt;+8&gt;:     sub    $0x10,%rsp
   0x00007ffff7fbd145 &lt;+12&gt;:    mov    $0x20,%edi
   0x00007ffff7fbd14a &lt;+17&gt;:    callq  0x7ffff7fbd070 &lt;malloc@plt&gt;
   0x00007ffff7fbd14f &lt;+22&gt;:    mov    %rax,-0x8(%rbp)
   0x00007ffff7fbd153 &lt;+26&gt;:    mov    -0x8(%rbp),%rax
   0x00007ffff7fbd157 &lt;+30&gt;:    lea    0xea2(%rip),%rdx        # 0x7ffff7fbe000
   0x00007ffff7fbd15e &lt;+37&gt;:    mov    $0x20,%esi
   0x00007ffff7fbd163 &lt;+42&gt;:    mov    %rax,%rdi
   0x00007ffff7fbd166 &lt;+45&gt;:    mov    $0x0,%eax
   0x00007ffff7fbd16b &lt;+50&gt;:    callq  0x7ffff7fbd060 &lt;snprintf@plt&gt;
=&gt; 0x00007ffff7fbd170 &lt;+55&gt;:    mov    0x2e69(%rip),%rax        # 0x7ffff7fbffe0
   0x00007ffff7fbd177 &lt;+62&gt;:    movl   $0x9,(%rax)
   0x00007ffff7fbd17d &lt;+68&gt;:    movl   $0x0,-0xc(%rbp)
   0x00007ffff7fbd184 &lt;+75&gt;:    movl   $0xa,-0xc(%rbp)
   0x00007ffff7fbd18b &lt;+82&gt;:    mov    $0x0,%eax
   0x00007ffff7fbd190 &lt;+87&gt;:    leaveq
   0x00007ffff7fbd191 &lt;+88&gt;:    retq
End of assembler dump.
</code></pre><p>&#x7A0B;&#x5E8F;&#x6267;&#x884C;&#x5230; mov    0x2e69(%rip),%rax        # 0x7ffff7fbffe0 &#x8FD9;&#x6761;&#x6307;&#x4EE4;&#xFF0C;&#x5BF9;&#x53D8;&#x91CF; mem_tst &#x7684;&#x5BFB;&#x5740;&#x65B9;&#x5F0F;&#x4E3A;&#x4E0B;&#x4E00;&#x6761;&#x6307;&#x4EE4;&#x7684;&#x865A;&#x62DF;&#x5730;&#x5740; + &#x504F;&#x79FB;&#xFF08;0x2e69&#xFF09;&#x5373;&#x4E3A;&#x8BE5;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x7684;&#x5B9E;&#x9645;&#x5730;&#x5740;&#xFF0C;&#x6B64;&#x5904; mem_tst &#x5BFB;&#x5230;&#x7684;&#x5730;&#x5740;&#x5373;&#x4E3A; 0x00007ffff7fbd177 + 0x2e69 = 0x7ffff7fbffe0&#xFF0C;&#x548C;&#x91CD;&#x5B9A;&#x4F4D;&#x533A; .rela.dyn &#x4E2D; mem_tst &#x7684; Offset &#x4FDD;&#x5B58;&#x7684;&#x53D8;&#x91CF;&#x7684;&#x771F;&#x5B9E;&#x5730;&#x5740;&#x76F8;&#x540C;&#x3002;<br>&#x6CE8;&#xFF1A;x64&#x65B0;&#x589E;&#x7684;RIP&#x76F8;&#x5BF9;&#x5BFB;&#x5740;&#xFF0C; &#x662F; 64 &#x4F4D;&#x7A0B;&#x5E8F;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x60EF;&#x7528;&#x7684;&#x5BFB;&#x5740;&#x65B9;&#x5F0F;&#xFF0C;&#x4EC5;&#x4EC5;&#x53EA;&#x662F;&#x56E0;&#x4E3A; rip &#x7684;&#x503C;&#x662F;&#x73B0;&#x6210;&#x7684;&#xFF08;&#x5176;&#x5B83;&#x5BC4;&#x5B58;&#x5668;&#x5C31;&#x4E0D;&#x7075;&#xFF09;&#xFF0C;&#x504F;&#x79FB;&#x7684;&#x503C;&#x4E5F;&#x662F;&#x786E;&#x5B9A;&#x7684;&#xFF08;&#x6B64;&#x4F8B;&#x4E2D;&#x504F;&#x79FB;&#x503C; 0x2e69&#xFF09;&#xFF0C;&#x90A3;&#x4E48;&#xFF0C;&#x8FD9;&#x4E2A;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x7684;&#x5730;&#x5740;&#x4E5F;&#x5C31;&#x786E;&#x5B9A;&#x4E86;&#xFF0C;&#x4E0D;&#x7528;&#x6267;&#x884C;&#xFF0C;&#x53CD;&#x6C47;&#x7F16;&#x5C31;&#x80FD;&#x786E;&#x5B9A;&#x6B64;&#x503C;&#x3002;</p>
<h3 id="&#x52A8;&#x6001;&#x5E93;&#x4E2D;&#x51FD;&#x6570;&#x7684;&#x91CD;&#x5B9A;&#x4F4D;&#x8FC7;&#x7A0B;">&#x52A8;&#x6001;&#x5E93;&#x4E2D;&#x51FD;&#x6570;&#x7684;&#x91CD;&#x5B9A;&#x4F4D;&#x8FC7;&#x7A0B;</h3>
<p>&#x5148;&#x6539;&#x9020;&#x4EE5;&#x4E0B;&#x52A8;&#x6001;&#x5E93;&#x4EE3;&#x7801;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;  </p>
<pre><code class="lang-c">#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
int mem_tst = 2;

int ts() {
    mem_tst = mem_tst + 3;
    return 0;
}

int memLibTest() {
    char* p1 = malloc(32);
    snprintf(p1, 32, &quot;hello, I am here in .so&quot;);
    mem_tst = 9;
    ts();
    int i = 0;
    i = 10;
    return 0;
}
</code></pre>
<p>dump&#x51FA;&#x6765;&#x7684;&#x6C47;&#x7F16;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;  </p>
<pre><code>x@ubuntu:~/work/libs/libraries$ objdump -d -j .text output/build/app/glibc/libtstmem.so

output/build/app/glibc/libtstmem.so:     file format elf64-x86-64


Disassembly of section .text:

0000000000001159 &lt;ts&gt;:
    1159:       f3 0f 1e fa             endbr64
    115d:       55                      push   %rbp
    115e:       48 89 e5                mov    %rsp,%rbp
    1161:       48 8b 05 78 2e 00 00    mov    0x2e78(%rip),%rax        # 3fe0 &lt;mem_tst@@Base-0x58&gt;
    1168:       8b 00                   mov    (%rax),%eax
    116a:       8d 50 03                lea    0x3(%rax),%edx
    116d:       48 8b 05 6c 2e 00 00    mov    0x2e6c(%rip),%rax        # 3fe0 &lt;mem_tst@@Base-0x58&gt;
    1174:       89 10                   mov    %edx,(%rax)
    1176:       b8 00 00 00 00          mov    $0x0,%eax
    117b:       5d                      pop    %rbp
    117c:       c3                      retq

000000000000117d &lt;memLibTest&gt;:
    117d:       f3 0f 1e fa             endbr64
    1181:       55                      push   %rbp
    1182:       48 89 e5                mov    %rsp,%rbp
    1185:       48 83 ec 10             sub    $0x10,%rsp
    1189:       bf 20 00 00 00          mov    $0x20,%edi
    118e:       e8 fd fe ff ff          callq  1090 &lt;malloc@plt&gt;
    1193:       48 89 45 f8             mov    %rax,-0x8(%rbp)
    1197:       48 8b 45 f8             mov    -0x8(%rbp),%rax
    119b:       48 8d 15 5e 0e 00 00    lea    0xe5e(%rip),%rdx        # 2000 &lt;_fini+0xe20&gt;
    11a2:       be 20 00 00 00          mov    $0x20,%esi
    11a7:       48 89 c7                mov    %rax,%rdi
    11aa:       b8 00 00 00 00          mov    $0x0,%eax
    11af:       e8 bc fe ff ff          callq  1070 &lt;snprintf@plt&gt;
    11b4:       48 8b 05 25 2e 00 00    mov    0x2e25(%rip),%rax        # 3fe0 &lt;mem_tst@@Base-0x58&gt;
    11bb:       c7 00 09 00 00 00       movl   $0x9,(%rax)
    11c1:       b8 00 00 00 00          mov    $0x0,%eax
    11c6:       e8 b5 fe ff ff          callq  1080 &lt;ts@plt&gt;
    11cb:       c7 45 f4 00 00 00 00    movl   $0x0,-0xc(%rbp)
    11d2:       c7 45 f4 0a 00 00 00    movl   $0xa,-0xc(%rbp)
    11d9:       b8 00 00 00 00          mov    $0x0,%eax
    11de:       c9                      leaveq
    11df:       c3                      retq
</code></pre><p>&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x5728; e8 b5 fe ff ff          callq  1080 <a href="mailto:ts@plt" target="_blank">ts@plt</a> &#x5904;&#x8C03;&#x7528;&#x4E86;ts&#x51FD;&#x6570;&#x3002;<br>&#x7EE7;&#x7EED;&#x67E5;&#x770B;&#x52A8;&#x6001;&#x91CD;&#x5B9A;&#x5411;&#x533A;&#x4FE1;&#x606F;</p>
<pre><code>x@ubuntu:~/work/libs/libraries$ readelf -r output/build/app/glibc/libtstmem.so

Relocation section &apos;.rela.dyn&apos; at offset 0x500 contains 8 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000003de8  000000000008 R_X86_64_RELATIVE                    1150
000000003df0  000000000008 R_X86_64_RELATIVE                    1110
000000004030  000000000008 R_X86_64_RELATIVE                    4030
000000003fd8  000100000006 R_X86_64_GLOB_DAT 0000000000000000 _ITM_deregisterTMClone + 0
000000003fe0  000800000006 R_X86_64_GLOB_DAT 0000000000004038 mem_tst + 0
000000003fe8  000300000006 R_X86_64_GLOB_DAT 0000000000000000 __gmon_start__ + 0
000000003ff0  000500000006 R_X86_64_GLOB_DAT 0000000000000000 _ITM_registerTMCloneTa + 0
000000003ff8  000600000006 R_X86_64_GLOB_DAT 0000000000000000 __cxa_finalize@GLIBC_2.2.5 + 0

Relocation section &apos;.rela.plt&apos; at offset 0x5c0 contains 3 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000004018  000200000007 R_X86_64_JUMP_SLO 0000000000000000 snprintf@GLIBC_2.2.5 + 0
000000004020  000900000007 R_X86_64_JUMP_SLO 0000000000001159 ts + 0
000000004028  000400000007 R_X86_64_JUMP_SLO 0000000000000000 malloc@GLIBC_2.2.5 + 0
</code></pre>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../dynamicLibrary.html" class="navigation navigation-prev " aria-label="Previous page: 2 动态库">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../../../../literature/literature.html" class="navigation navigation-next " aria-label="Next page: 文学">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"2.1 重定位","level":"1.2.2.2.1","depth":4,"next":{"title":"文学","level":"1.3","depth":1,"path":"literature/literature.md","ref":"literature/literature.md","articles":[{"title":"诗词","level":"1.3.1","depth":2,"path":"literature/poetry/poetry.md","ref":"literature/poetry/poetry.md","articles":[{"title":"苏轼","level":"1.3.1.1","depth":3,"path":"literature/poetry/sushi/sushi.md","ref":"literature/poetry/sushi/sushi.md","articles":[{"title":"《定风波·莫听穿林打叶声》","level":"1.3.1.1.1","depth":4,"path":"literature/poetry/sushi/1.md","ref":"literature/poetry/sushi/1.md","articles":[]}]}]}]},"previous":{"title":"2 动态库","level":"1.2.2.2","depth":3,"path":"computer/linux/dynamic_library/dynamicLibrary.md","ref":"computer/linux/dynamic_library/dynamicLibrary.md","articles":[{"title":"2.1 重定位","level":"1.2.2.2.1","depth":4,"path":"computer/linux/dynamic_library/relocation/relocation.md","ref":"computer/linux/dynamic_library/relocation/relocation.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":["-search","search-plus","-font-settings","-livereload","-highlight","-sharing","back-to-top-button","expandable-chapters-small","code","splitter","hide-element","chapter-fold","livereload"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"chapter-fold":{},"splitter":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"code":{"copyButtons":true},"hide-element":{"elements":[".gitbook-link"]},"fontsettings":{"theme":"white","family":"sans","size":2},"back-to-top-button":{},"expandable-chapters-small":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"theme":"default","author":"zhangkaiyuan","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"ebook","language":"zh-hans","gitbook":"*","description":"ebook"},"file":{"path":"computer/linux/dynamic_library/relocation/relocation.md","mtime":"2023-05-29T09:42:51.878Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2023-05-29T10:15:44.705Z"},"basePath":"../../../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../../../gitbook/gitbook.js"></script>
    <script src="../../../../gitbook/theme.js"></script>
    
        
        <script src="../../../../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-hide-element/plugin.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

